#!/bin/bash
echo "‚öôÔ∏è   Started pre-commit checks..."

# Generate NOTICE file with dependency licenses
echo "üìÑ  Generating NOTICE file..."

# Check if go-licenses is installed
if ! command -v go-licenses >/dev/null 2>&1; then
    echo "‚ùå  Error: go-licenses not installed."
    echo "    Install with: go install github.com/google/go-licenses/v2@latest"
    exit 1
fi

# Check if template file exists
if [ ! -f "notice.tpl" ]; then
    echo "‚ùå  Error: notice.tpl template file not found."
    exit 1
fi

# Generate NOTICE file (replaces existing if present)
if go-licenses report . --template=notice.tpl --include_tests > NOTICE.tmp 2> /dev/null; then
    # Replace NOTICE file
    mv NOTICE.tmp NOTICE
    
    # Stage NOTICE for commit
    git add NOTICE
    
    echo "‚úÖ  NOTICE file updated and staged"
else
    echo "‚ùå  Failed to generate NOTICE file"
    cat << 'HELP'
    
    Common issues:
    - Ensure you're in the project root directory
    - Check that go.mod exists and is valid
    - Run 'go mod download' if modules are missing
HELP
    rm -f NOTICE.tmp
    exit 1
fi

# Generate CLI documentation
echo "üìö  Generating CLI documentation..."

# Check if docs directory exists
if [ ! -d "docs" ]; then
    echo "‚ùå  Error: docs directory not found."
    exit 1
fi

# Generate markdown documentation
if go run internal/tools/docgen/main.go --out ./docs --format markdown 2> /dev/null; then
    # Stage documentation for commit
    git add docs/
    
    echo "‚úÖ  CLI documentation updated and staged"
    echo "‚úÖ  Finished pre-commit checks"
else
    echo "‚ùå  Failed to generate CLI documentation"
    cat << 'HELP'
    
    Common issues:
    - Ensure you're in the project root directory
    - Check that internal/tools/docgen/main.go exists
    - Verify that exiftool is installed and in PATH
    - Run 'go mod download' if modules are missing
HELP
    exit 1
fi
